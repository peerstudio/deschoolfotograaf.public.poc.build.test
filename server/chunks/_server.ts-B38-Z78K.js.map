{"version":3,"file":"_server.ts-B38-Z78K.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/send-mails/_server.ts.js"],"sourcesContent":["!(function() {\n  try {\n    var e = \"undefined\" != typeof window ? window : \"undefined\" != typeof global ? global : \"undefined\" != typeof globalThis ? globalThis : \"undefined\" != typeof self ? self : {};\n    e.SENTRY_RELEASE = { id: \"8a555e7f1a2aff28713c57fe6955c74723dfdd47\" };\n  } catch (e2) {\n  }\n})();\n;\n{\n  try {\n    (function() {\n      var e = \"undefined\" != typeof window ? window : \"undefined\" != typeof global ? global : \"undefined\" != typeof globalThis ? globalThis : \"undefined\" != typeof self ? self : {}, n = new e.Error().stack;\n      n && (e._sentryDebugIds = e._sentryDebugIds || {}, e._sentryDebugIds[n] = \"bc211f27-2363-471f-b6e5-5eb8a9634bc7\", e._sentryDebugIdIdentifier = \"sentry-dbid-bc211f27-2363-471f-b6e5-5eb8a9634bc7\");\n    })();\n  } catch (e) {\n  }\n}\n;\nimport { json } from \"@sveltejs/kit\";\nimport { s as sendEmail } from \"../../../../chunks/email.js\";\nimport { g as getDb } from \"../../../../chunks/index4.js\";\nimport { readFile } from \"fs/promises\";\nimport { join } from \"path\";\nimport { b as private_env } from \"../../../../chunks/shared-server.js\";\nimport { d as dev } from \"../../../../chunks/index5.js\";\nconst GET = async () => {\n  const results = {\n    processed: 0,\n    sent: 0,\n    failed: 0,\n    errors: []\n  };\n  try {\n    const pendingEmails = await getDb().emailMessage.findMany({\n      where: {\n        sentAttemp: {\n          lt: 3\n        },\n        deactivatedOn: null,\n        sentOn: null\n      }\n    });\n    if (pendingEmails.length === 0) {\n      return json({\n        success: true,\n        message: \"No pending emails to process\",\n        ...results\n      });\n    }\n    const logoPath = dev ? join(process.cwd(), \"static\", \"logo_small.jpg\") : join(process.cwd(), \"client\", \"logo_small.jpg\");\n    let logoBuffer;\n    try {\n      logoBuffer = await readFile(logoPath);\n    } catch (error) {\n      console.error(\"Failed to load logo file from:\", logoPath, error);\n      return json(\n        {\n          success: false,\n          error: \"Logo file not found\",\n          ...results\n        },\n        { status: 500 }\n      );\n    }\n    for (const emailMessage of pendingEmails) {\n      results.processed++;\n      try {\n        await getDb().emailMessage.update({\n          where: { id: emailMessage.id },\n          data: {\n            sentAttemp: emailMessage.sentAttemp + 1\n          }\n        });\n        const to = emailMessage.to.split(\";\").filter(Boolean);\n        const cc = emailMessage.cc?.split(\";\").filter(Boolean) || void 0;\n        const bcc = emailMessage.bcc?.split(\";\").filter(Boolean) || void 0;\n        const catchAllEmail = private_env.EMAIL_CATCHALL;\n        const actualTo = catchAllEmail || (to.length === 1 ? to[0] : to);\n        const emailResult = await sendEmail({\n          to: actualTo,\n          subject: emailMessage.subject,\n          html: emailMessage.body,\n          cc: cc && cc.length > 0 ? cc.length === 1 ? cc[0] : cc : void 0,\n          bcc: bcc && bcc.length > 0 ? bcc.length === 1 ? bcc[0] : bcc : void 0,\n          attachments: [\n            {\n              filename: \"logo_small.jpg\",\n              content: logoBuffer,\n              cid: \"logo\"\n              // Content-ID for embedding in HTML\n            }\n          ]\n        });\n        if (emailResult.success) {\n          await getDb().emailMessage.update({\n            where: { id: emailMessage.id },\n            data: {\n              sentOn: /* @__PURE__ */ new Date()\n            }\n          });\n          results.sent++;\n          console.log(`Email ${emailMessage.id} sent successfully`);\n        } else {\n          results.failed++;\n          results.errors.push({\n            id: emailMessage.id,\n            error: emailResult.error || \"Unknown error\"\n          });\n          console.error(`Failed to send email ${emailMessage.id}:`, emailResult.error);\n        }\n      } catch (error) {\n        results.failed++;\n        const errorMessage = error instanceof Error ? error.message : \"Unknown error\";\n        results.errors.push({\n          id: emailMessage.id,\n          error: errorMessage\n        });\n        console.error(`Error processing email ${emailMessage.id}:`, error);\n      }\n    }\n    return json({\n      success: true,\n      message: `Processed ${results.processed} emails: ${results.sent} sent, ${results.failed} failed`,\n      ...results\n    });\n  } catch (error) {\n    console.error(\"Error in send-mails endpoint:\", error);\n    return json(\n      {\n        success: false,\n        error: error instanceof Error ? error.message : \"Failed to process emails\",\n        ...results\n      },\n      { status: 500 }\n    );\n  }\n};\nexport {\n  GET\n};\n"],"names":[],"mappings":"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"}